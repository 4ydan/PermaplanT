pipeline {
    agent { label 'permaplant' }

    stages {
        stage('Build') {
            environment {
                DATABASE_URL = 'postgres://cidb:cidb@127.0.0.1/cidb'
            }

            steps {
                echo "Workspace is '${WORKSPACE}'"

                echo 'Resetting the CI DB ...'
                sh 'sudo /usr/local/bin/permaplant-reset-ci.sh'

                echo 'Building...'
                sh './ci/build-scripts/build-backend.sh'
                sh './ci/build-scripts/build-frontend.sh'
            }
        }

        stage('Deploy to Dev') {
            when {
                branch "master"
            }

            steps {
                echo 'Deploying to Dev ...'
                sh 'sudo -u permaplant /usr/local/bin/permaplant-setup-dev.sh'
                sh 'sudo /usr/local/bin/permaplant-deploy-dev.sh'
            }
        }
    }
}
